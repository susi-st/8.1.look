<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>社區高中職涯參訪志願調查</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 字體 */
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        
        /* 拖曳方塊的基本樣式 */
        .course-block {
            touch-action: none; /* 禁用觸控捲動，以利拖曳 */
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        /* 當方塊被拖曳時的樣式 */
        .course-block.dragging {
            opacity: 0.4;
            transform: scale(0.95);
        }

        /* 可放置的目標區域 */
        .rank-box, #source-container {
            min-height: 100px; /* 確保空白區域也有足夠的高度可以觸發 drop 事件 */
            transition: background-color 0.2s ease;
        }
        
        /* 當拖曳物體進入可放置區域時的提示樣式 */
        .drag-over {
            background-color: #f0f9ff; /* 淺藍色背景 */
            border-style: solid;
        }

        /* 錯誤訊息提示框 */
        #message-box {
            display: none; /* 預設隱藏 */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-xl">

        <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">社區高中職涯參訪志願調查</h1>

        <!-- 1. 志願方塊區 (可拖曳來源) -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">參訪科系與實作主題：(滑鼠移到科系上會出現進一步說明)</h2>
            <div id="source-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-300">
                <!-- 志願方塊將由 JavaScript 動態生成於此 -->
            </div>
        </div>

        <!-- 2. 志願排序區 (放置目標) - !! 已修復 !! -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">我的志願序（請將上方科系方塊依你最想了解的順序，依序拖到下方的方框中)：</h2>
            <div id="target-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                <!-- 志願排序框將由 JavaScript 動態生成於此 -->
            </div>
        </div>

        <!-- 3. 即時顯示區 (即時志願序) -->
        <div class="mb-8 overflow-x-auto">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">
                志願即時預覽：
                <!-- 這裡將顯示用逗號分隔的志願ID -->
                <span id="summary-string" class="text-lg font-mono text-blue-600">---</span>
            </h2>
        </div>

        <!-- 4. 使用者資訊輸入 -->
        <div id="user-info-form" class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="seat" class="block text-sm font-medium text-gray-700 mb-1">座號：</label>
                <input type="text" id="seat" name="seat" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名：</label>
                <input type="text" id="name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <!-- 5. 提示訊息框 -->
        <div id="message-box" class="p-4 mb-4 rounded-md text-sm">
            <!-- 錯誤或成功訊息將顯示於此 -->
        </div>

        <!-- 6. 送出按鈕 -->
        <div class="text-center">
            <button id="submit-button" class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                確認無誤，送出
            </button>
        </div>

    </div>

    <script>
        // 存放10個科系的資料
        const courses = [
            { id: 1, dept: "電子科", title: "電路設計DIY", description: "電子電路套件實作，完成後會有意想不到的功能" },
            { id: 2, dept: "寵經科", title: "寵愛毛小孩", description: "寵物飾品配件製作" },
            { id: 3, dept: "機械科", title: "泡殼迴力車", description: "真空成型機秒速成型，應用創意製作模具" },
            { id: 4, dept: "廣設科", title: "二次元文創藝術世界", description: "商品圖紋設計製作並以熱轉印技術完成商品印製" },
            { id: 5, dept: "室設科", title: "木作模型小達人", description: "基礎手作桌椅木質家具模型並彩繪上色" },
            { id: 6, dept: "美容科", title: "指尖上的藝術", description: "以光療技巧，劃出抽象線條完成甲片，製作吊飾" },
            { id: 7, dept: "餐飲科", title: "藍帶一番小當家", description: "餅乾蛋糕製作或中西式餐點製作" },
            { id: 8, dept: "觀光科", title: "雪克搖搖搖", description: "各式飲料特性學與調製" },
            { id: 9, dept: "幼保科", title: "偶來與你相遇", description: "設計製作各式可愛的玩偶與手偶" },
            { id: 10, dept: "應英科", title: "拼豆世界", description: "全方位英語學習，創意拼豆手作課，拼出你的想像力" }
        ];

        // 10種不同的顏色 (Tailwind classes)
        const colors = [
            'bg-red-200', 'bg-blue-200', 'bg-green-200', 'bg-yellow-200', 'bg-purple-200',
            'bg-pink-200', 'bg-indigo-200', 'bg-teal-200', 'bg-orange-200', 'bg-gray-300'
        ];

        // 當 DOM 載入完成後執行
        document.addEventListener('DOMContentLoaded', () => {

            const sourceContainer = document.getElementById('source-container');
            const targetContainer = document.getElementById('target-container'); // 現在這個 ID 應該可以被正確找到了
            // const summaryTable = document.getElementById('summary-table'); // 表格已移除
            const summarySpan = document.getElementById('summary-string'); // 新的預覽位置
            const submitButton = document.getElementById('submit-button');
            const messageBox = document.getElementById('message-box');

            let draggedItem = null; // 儲存目前正在拖曳的元素

            // --- 1. 初始化頁面 ---

            // 1.1. 產生可拖曳的志願方塊
            courses.forEach((course, index) => {
                const block = document.createElement('div');
                block.id = `course-${course.id}`;
                block.className = `course-block p-3 rounded-md shadow cursor-move text-center ${colors[index % colors.length]}`;
                block.draggable = true;
                block.setAttribute('title', course.description); // 滑鼠移上時顯示說明
                block.setAttribute('data-course-id', course.id);
                block.setAttribute('data-course-text', `${course.id}.${course.dept}－${course.title}`);
                block.innerHTML = `<span class="font-bold">${course.id}. ${course.dept}</span><br><span class="text-sm">${course.title}</span>`;
                
                sourceContainer.appendChild(block);
            });

            // 1.2. 產生志願排序方框 (可放置目標)
            // const tableHeaderRow = summaryTable.querySelector('thead tr'); // 表格已移除
            // const tableBodyRow = summaryTable.querySelector('tbody tr'); // 表格已移除
            
            for (let i = 1; i <= 10; i++) {
                // 產生排序框
                const rankBox = document.createElement('div');
                rankBox.className = 'rank-box border-2 border-dashed border-gray-400 rounded-lg p-2 flex justify-center items-center';
                rankBox.setAttribute('data-rank', i);
                
                // 排序框內的提示文字
                const rankLabel = document.createElement('span');
                rankLabel.className = 'text-gray-500 font-semibold';
                
                // 根據要求修改志願1的文字
                if (i === 1) {
                    rankLabel.textContent = `志願 ${i} (最想了解)`;
                } else {
                    rankLabel.textContent = `志願 ${i}`;
                }
                
                rankBox.appendChild(rankLabel);

                // !! 錯誤修復 !!
                // 將建立好的排序框 (rankBox) 加入到目標容器 (targetContainer) 中
                targetContainer.appendChild(rankBox);

                // 產生表格標題 (已移除)
                // const th = document.createElement('th');
                // ...
                // 產生表格內容格 (已移除)
                // const td = document.createElement('td');
                // ...
            }
            
            // 立即更新一次預覽 (顯示 'X,X,X...')
            updateSummaryPreview();

            // --- 2. 拖曳事件監聽 ---

            // 監聽所有可拖曳方塊的 dragstart 和 dragend
            document.querySelectorAll('.course-block').forEach(block => {
                block.addEventListener('dragstart', (e) => {
                    draggedItem = e.target; // 記錄被拖曳的元素
                    setTimeout(() => e.target.classList.add('dragging'), 0); // 增加視覺效果
                    e.dataTransfer.setData('text/plain', e.target.id);
                });

                block.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging'); // 移除視覺效果
                    draggedItem = null;
                });
            });

            // 監聽所有可放置區域 (排序框 和 原始方塊區)
            [sourceContainer, ...document.querySelectorAll('.rank-box')].forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault(); // 必須阻止預設行為，否則 drop 不會觸發
                    zone.classList.add('drag-over'); // 增加進入區域的視覺提示
                });

                zone.addEventListener('dragleave', (e) => {
                    zone.classList.remove('drag-over'); // 移除視覺提示
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    if (!draggedItem) return;

                    const targetZone = e.target.closest('.rank-box, #source-container');
                    
                    if (targetZone.classList.contains('rank-box')) {
                        // 情況 1: 拖入一個排序框
                        
                        // 隱藏排序框的 "志願 X" 提示文字
                        const label = targetZone.querySelector('span');
                        if (label) label.style.display = 'none';

                        // 檢查排序框中是否已有方塊
                        const existingBlock = targetZone.querySelector('.course-block');
                        if (existingBlock) {
                            // 如果有，將舊方塊移回來源區
                            sourceContainer.appendChild(existingBlock);
                        }
                        
                        // 將新方塊移入排序框
                        targetZone.appendChild(draggedItem);
                    } 
                    else if (targetZone.id === 'source-container') {
                        // 情況 2: 拖回來源區
                        
                        // 檢查 draggedItem 是否是從排序框拖回的
                        const originalRankBox = draggedItem.closest('.rank-box');
                        if (originalRankBox) {
                            // 顯示排序框的 "志願 X" 提示文字
                            const label = originalRankBox.querySelector('span');
                            if (label) label.style.display = 'block';
                        }
                        
                        // 將方塊移回來源區
                        sourceContainer.appendChild(draggedItem);
                    }
                    
                    // updateSummaryTable(); // 舊的表格更新
                    updateSummaryPreview(); // 更新新的字串預覽
                });
            });

            // --- 3. 更新即時預覽字串 ---
            function updateSummaryPreview() {
                let summaryData = [];
                let allRanked = true;

                for (let i = 1; i <= 10; i++) {
                    const rankBox = document.querySelector(`.rank-box[data-rank='${i}']`);
                    const block = rankBox.querySelector('.course-block');

                    if (block) {
                        // 如果方框中有方塊，取得 'data-course-id' (例如 "1", "2")
                        summaryData.push(block.getAttribute('data-course-id'));
                    } else {
                        // 如果是空的，顯示 "X"
                        summaryData.push('X');
                        allRanked = false;
                    }
                }
                
                const summaryString = summaryData.join(',');
                summarySpan.textContent = summaryString;

                // 如果未填滿，顯示紅色
                if (allRanked) {
                    summarySpan.classList.remove('text-red-500');
                    summarySpan.classList.add('text-blue-600');
                } else {
                    summarySpan.classList.remove('text-blue-600');
                    summarySpan.classList.add('text-red-500');
                }
            }
            
            // --- 4. 提交按鈕事件 ---
            submitButton.addEventListener('click', () => {
                const seat = document.getElementById('seat').value.trim();
                const name = document.getElementById('name').value.trim();
                let errors = [];
                
                // 4.1. 檢查志願序是否填滿並產生志願字串
                let allRanked = true;
                let orderData = [];
                for (let i = 1; i <= 10; i++) {
                    const rankBox = document.querySelector(`.rank-box[data-rank='${i}']`);
                    const block = rankBox.querySelector('.course-block');
                    if (!block) {
                        allRanked = false;
                    } else {
                        orderData.push(block.getAttribute('data-course-id'));
                    }
                }
                
                // 最終要送出的志願字串
                const orderString = orderData.join(',');
                
                if (!allRanked) {
                    errors.push('所有的志願序都必須填滿！');
                }

                // 4.2. 檢查座號
                if (seat === '') {
                    errors.push('請填寫座號！');
                }

                // 4.3. 檢查姓名
                if (name === '') {
                    errors.push('請填寫姓名！');
                }

                // 4.4. 顯示錯誤或送出
                if (errors.length > 0) {
                    // 顯示錯誤訊息
                    messageBox.style.display = 'block';
                    messageBox.className = 'p-4 mb-4 rounded-md text-sm bg-red-100 border border-red-400 text-red-700';
                    messageBox.innerHTML = errors.join('<br>');
                } else {
                    // 驗證通過，執行送出
                    messageBox.style.display = 'block';
                    messageBox.className = 'p-4 mb-4 rounded-md text-sm bg-green-100 border border-green-400 text-green-700';
                    messageBox.textContent = '驗證成功，正在送出資料...';
                    
                    // 禁用按鈕和輸入欄位，防止重複送出
                    submitButton.disabled = true;
                    submitButton.textContent = '已送出';
                    submitButton.classList.add('bg-gray-400', 'hover:bg-gray-400');
                    document.getElementById('seat').disabled = true;
                    document.getElementById('name').disabled = true;
                    // 讓所有方塊無法再拖曳
                    document.querySelectorAll('.course-block').forEach(b => b.draggable = false);

                    // 準備要送出的最終資料
                    const finalFormData = {
                        seat: seat,
                        name: name,
                        order: orderString // 這就是 "1,5,3,..." 的字串
                    };

                    // 呼叫送出函式
                    submitToGoogleForm(finalFormData);
                }
            });

            // --- 5. Google 表單送出 (已串接) ---
            function submitToGoogleForm(formData) {
                // 真正的串接，使用您提供的 Google 表單連結
                
                console.log('準備送出的資料:', formData);

                // 1. 您的表單送出網址
                const googleFormURL = "https://docs.google.com/forms/d/e/1FAIpQLScpLCzpYsN43k5LdfjAD2J_OlhfdVYx7MQYtKmKp-AkIuwhrA/formResponse";
                
                // 2. 建立要送出的資料
                const params = new URLSearchParams();

                // 3. 根據您提供的連結，對應欄位 ID
                // entry.514985165 = 座號 (no)
                // entry.157293360 = 姓名 (name)
                // entry.1509051622 = 志願序 (order)
                
                params.append('entry.514985165', formData.seat);
                params.append('entry.157293360', formData.name);
                params.append('entry.1509051622', formData.order); // 送出 "1,5,3..." 字串

                // 4. 使用 fetch (POST) 提交表單
                // 使用 'no-cors' 模式，這會發送請求，但無法從程式碼中得知是否真的成功
                // (這是純前端提交 Google 表單的限制)
                
                fetch(googleFormURL + "?" + params.toString(), {
                    method: 'POST',
                    mode: 'no-cors', // 'no-cors' 模式會發送請求，但無法讀取回應
                })
                .then(() => {
                    messageBox.textContent = '資料已送出！感謝您的填寫。';
                    // 這裡不能保證 100% 成功，因為 'no-cors' 看不到回應
                    // 但通常 Google 表單會收到資料
                })
                .catch(error => {
                    console.error('送出時發生錯誤:', error);
                    messageBox.textContent = '送出失敗，請檢查網路連線或聯絡管理員。';
                    messageBox.className = 'p-4 mb-4 rounded-md text-sm bg-red-100 border border-red-400 text-red-700';
                    // 重新啟用按鈕，讓使用者可以重試
                    submitButton.disabled = false;
                    submitButton.textContent = '確認無誤，送出';
                    submitButton.classList.remove('bg-gray-400', 'hover:bg-gray-400');
                    document.getElementById('seat').disabled = false;
                    document.getElementById('name').disabled = false;
                    document.querySelectorAll('.course-block').forEach(b => b.draggable = true);
                });

            }
        });
    </script>

</body>
</html>
